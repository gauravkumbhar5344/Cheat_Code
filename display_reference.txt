import streamlit as st
from langchain.chat_models import ChatGroq
from langchain.chains import ConversationalRetrievalChain
from langchain.vectorstores import FAISS
from langchain.embeddings import HuggingFaceEmbeddings
from langchain.document_loaders import TextLoader
import tempfile

st.set_page_config(page_title="RAG Assistant with References", layout="centered")

if "vectorstore" not in st.session_state:
    st.session_state.vectorstore = None

st.sidebar.title("Navigation")
page = st.sidebar.radio("Go to", ["Upload Docs", "Chat"])

# -----------------------------
# 1ï¸âƒ£ Upload Page
# -----------------------------
if page == "Upload Docs":
    st.title("ðŸ“„ Upload Documents for RAG Knowledge Base")
    uploaded_files = st.file_uploader("Upload .txt files", type=["txt"], accept_multiple_files=True)

    if uploaded_files:
        all_docs = []
        for file in uploaded_files:
            tmp_path = tempfile.NamedTemporaryFile(delete=False).name
            with open(tmp_path, "wb") as f:
                f.write(file.read())

            loader = TextLoader(tmp_path)
            docs = loader.load()
            all_docs.extend(docs)

        embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/all-MiniLM-L6-v2")
        st.session_state.vectorstore = FAISS.from_documents(all_docs, embeddings)
        st.success("âœ… Documents processed and stored successfully!")

# -----------------------------
# 2ï¸âƒ£ Chat Page
# -----------------------------
elif page == "Chat":
    st.title("ðŸ¤– Chat with RAG Assistant")

    if not st.session_state.vectorstore:
        st.warning("Please upload documents first.")
    else:
        retriever = st.session_state.vectorstore.as_retriever()
        llm = ChatGroq(temperature=0)

        # Enable reference document return
        rag_chain = ConversationalRetrievalChain.from_llm(
            llm=llm,
            retriever=retriever,
            return_source_documents=True
        )

        user_input = st.text_input("Ask a question about your uploaded content:")

        if user_input:
            with st.spinner("Thinking..."):
                result = rag_chain({"question": user_input, "chat_history": []})
                answer = result["answer"]
                sources = result["source_documents"]

            # Display answer
            st.markdown(f"### ðŸ§  Answer\n{answer}")

            # Display references
            st.markdown("---")
            st.markdown("### ðŸ“š References (Source Documents)")
            for i, doc in enumerate(sources):
                st.markdown(f"**Reference {i+1}:**")
                st.markdown(f"> {doc.page_content[:400]}...")
                st.caption(f"Source file: `{doc.metadata.get('source', 'unknown')}`")
